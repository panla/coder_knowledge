# 反射

[toc]

## 0

反射是指计算机程序在运行时可以动态地访问、检测和修改本身状态或行为的能力。

Go 语言反射的基础是**接口和类型系统**，是编译器和运行时把类型信息以合适的数据结构保存在可执行程序中。

reflect

## 1 基本概念

Go 语言反射借助了实例到接口的转换所使用的数据结构，
首先将实例传递给内部的空接口，把一个实例类型转换为接口可以表述的数据结构 eface
反射基于这个转换后的数据结构来访问和操作实例的值和类型。

### 1.1 基本数据结构和入口函数

rtype：描述类型公共信息的结构，实现了接口 reflect.Type，reflect 包通过函数 reflect.TypeOf() 返回一个 Type 类型的接口变量，通过接口抽象出的方法访问具体类型信息

```go
type rtype struct {
    size        uintptr
    ptrdata     uintptr
    hash        uint32
    tflag       tflag
    align       uint8
    fieldAlign  uint8
    kind        uint8
    alg         *typeAlg
    gcdata      *byte
    str         nameOff
    ptrToThis   typeOff
}
```

### 1.2 reflect.TypeOf 函数原型

```text
func TypeOf(i interface{}) Type

传进入的实参：
    接口变量：
        如果绑定了具体类型实例，返回接口的动态类型(绑定的具体实例类型的信息)
        没有绑定，返回自身静态类型信息
    具体类型变量，返回具体类型信息
```

### 1.3 reflect.Type 接口方法，通用方法

```go
type Type interface {
    Name() string // 返回包含包名的类型名字，nil

    Kind() Kind // 返回该类型的底层基础类型

    Implements(u Type) bool // 确定当前类型是否实现了 u 接口类型，u 必须是接口类型的 Type

    AssignableTo(u Type) bool // 返回当前类型的实例是否能赋值给 type=u 的类型变量

    ConvertibleTo(u Type) bool // 判断能否强制转换

    Comparable() bool // 是否支持比较，(等于或不等于)

    Nummethod() int  // 返回该类型的方法个数

    Method(int) Method // 通过索引访问方法

    MethodByName(string) (Method, bool) // 通过方法名获取 Method

    PkgPath() string // 返回类型的包路径，""

    Size() uintptr // 返回存放该类型的实例需要多大的字节空间
    ...
}
```

### 1.4 reflect.Type 接口方法，类型特有方法

```text
Elem() Type

Bits() int

NumField() int
...

```

### 1.5 reflect.Value

表示实例的值信息

```go
type Value struct {
    // 值的类型指针
    typ *rtype

    // 值的指针
    ptr unsafe.Pointer

    flag
}
```

## 2 基础类型
