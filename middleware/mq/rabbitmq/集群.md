# 集群

## command

```bash
# 加入集群
# 内存节点
rabbitmqctl join_cluster --ram rabbit@myRabbitmq-11

# 重置机群状态
rabbitmqctl reset

# 磁盘节点
rabbitmqctl join_cluster rabbit@myRabbitmq-11

# 如果想要更改节点类型，可以使用命令,前提是必须停掉rabbit应用
rabbitmqctl change_cluster_node_type disc(ram)

# 开启镜像队列
rabbitmqctl set_policy ha-all "^" '{"ha-mode":"all"}'

# 指定复制系数
rabbitmqctl set_policy ha-two "^" '{"ha-mode":"exactly","ha-params":2,"ha-sync-mode":"automatic"}'

#
```

## 内存节点和磁盘节点

```text
内存节点只是把元数据存在内存中，磁盘节点只是把元数据存在磁盘中
对于队列/消息的持久化或非持久化方式 和 磁盘节点/内存节点 无关，持久化就存磁盘，非持久化就存内存

在持久化队列中，节点存储类型对消息存取速度无影响
在非持久化队列中，消息存取速度得到提升，
重启会丢失消息(无论节点类型)
```

## 连接与代理

经测试，消费者和生产者 各自使用集群中的不同 节点，也可以成功通信

1，一个基本的 RabbitMQ 集群 虽然集群共享队列，但在默认情况下，消息只会被路由到某一个节点的符合条件的队列上，并不会同步到其他节点的相同队列上。
2，开启队列镜像，将集群中的队列彼此之间进行镜像，此时消息就会被拷贝到处于同一个镜像分组中的所有队列上
3，RabbitMQ 集群 本身未提供负载均衡
4，除非是将 RabbitMQ 用于 RPC 这种需要超低延迟的场景，否则在大多数情况下，磁盘节点的性能都是够用的。
5，如果节点以磁盘节点的形式加入，则需要先使用 reset 命令进行重置，内存节点不需

### HAProxy

客户端 -> TCP 代理服务器 HAProxy -> MQ-1 MQ-2

HAProxy 做 TCP 代理，提供节点负载均衡

### KeepAlived

对 HAProxy 之间进行故障转移

## 集群模式

- 镜像
- 主从

## 问题

- [ ] 没有开启镜像队列时的 连接方式
  - 1 生产者连接磁盘节点发送消息，消费者连接内存节点来消费消息。
  - 2 生产者连接内存节点发送消息，消费者连接磁盘节点来消费消息。
  - 3 生产者和消费者均连接内存节点。
  - 4 生产者和消费者均连接磁盘节点。
  - 4 连接同一个。
  - 5 随意。
  - 连接到虚拟 IP

- [ ] 内存节点与磁盘节点的比例
