# 集群

## 分片

Redis Cluster 提供一种Redis安装方式：数据自动在多个Redis节点间分片

Redis集群不是使用一致性哈希，而是使用哈希槽。整个redis集群有16384个哈希槽，决定一个key应该分配到那个槽的算法是：计算该key的CRC16结果再模16834。

## 主从模式

每个哈希槽有 1 -- n 个副本，1 个主节点，n-1 个从节点，主节点故障，从节点升为主节点

## 一致性保证

Redis集群不能保证强一致性。

写操作丢失的原因：

- 1 主从节点之间使用了异步的方式来同步数据

## 参数配置

redis.conf

- cluster-enabled yes/no 开启了，则是集群的一个节点
- cluster-config-file filename 集群配置文件
- cluster-node-timeout 毫秒 主节点超时不可达，则从节点升为主节点

最小 三主三从

## 系统参数

```text
WARNING overcommit_memory is set to 0! Background save may fail under low memory condition.
To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf
and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
```

## command

开启集群后，**对其操作也要相对应的使用集群参数**

```bash
redis-cli -c
```

### 创建

```bash
echo yes | redis-cli -a 12345678 --cluster create IP IP --cluster-replicas 1
```

参数

```text
--cluster-replicas 1 表示为每一个主服务器配一个重服务器
```

结果显示

```text
Master[0] -> Slots 0 - 5460
Master[1] -> Slots 5461 - 10922
Master[2] -> Slots 10923 - 16383
Adding replica 172.20.2.6:6379 to 172.20.2.2:6379
Adding replica 172.20.2.7:6379 to 172.20.2.3:6379
Adding replica 172.20.2.5:6379 to 172.20.2.4:6379
```

### 添加新节点

```bash
redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000

# 重新分配哈希槽
redis-cli reshard 127.0.0.1:7000
# 输入哈希槽数量 和 目标 node-id 和 源(all)
```

```bash
# 增加从节点
redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000 --cluster-slave
redis-cli --cluster add-node 127.0.0.1:7006 127.0.0.1:7000 --cluster-slave --cluster-master-id 3c3a0c74aae0b56170ccb03a76b60cfe7dc1912e
```

### 删除节点

不能移除非空的主节点，先把哈希槽移出，再移除节点

```bash
redis-cli --cluster del-node 127.0.0.1:7000 `<node-id>`
```
